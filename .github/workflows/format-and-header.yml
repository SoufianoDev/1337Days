name: Format and Add 42 Header

on:
  push:
    branches:
      - main

jobs:
  format-and-header:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "contact.devsoufiano@gmail.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Norminette
        run: |
          python3 -m pip install --upgrade pip
          pip install norminette

      - name: Add 42 Header Safely
        run: |
          expected_header=(
            "/* ************************************************************************** */"
            "/*                                                                            */"
            "/*                                                        :::      ::::::::   */"
            "/*   FILENAME_PLACEHOLDER                             :+:      :+:    :+:   */"
            "/*                                                    +:+ +:+         +:+     */"
            "/*   By: AUTHOR_EMAIL_PLACEHOLDER                  +#+  +:+       +#+        */"
            "/*                                                +#+#+#+#+#+   +#+           */"
            "/*   Created: CREATED_DATE_PLACEHOLDER by AUTHOR_NAME_PLACEHOLDER       #+#    #+#             */"
            "/*   Updated: UPDATED_DATE_PLACEHOLDER by AUTHOR_NAME_PLACEHOLDER       ###   ########.fr       */"
            "/*                                                                            */"
            "/* ************************************************************************** */"
          )

          author="${{ github.actor }}"
          email="contact.devsoufiano@gmail.com"

          for file in $(find . -type f \( -name "*.c" -o -name "*.h" \)); do
            filename=$(basename "$file")
            created=$(git log --diff-filter=A --format="%ad" --date=format:"%Y/%m/%d %H:%M:%S" -- "$file" | head -n 1)
            [ -z "$created" ] && created=$(date +"%Y/%m/%d %H:%M:%S")
            updated=$(date +"%Y/%m/%d %H:%M:%S")

            if head -n 15 "$file" | grep -q "42 Header Generator"; then
              sed -i -E "s#(Created: )[0-9]{4}/[0-9]{2}/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} by [^ ]+#\1$created by $author#" "$file"
              sed -i -E "s#(Updated: )[0-9]{4}/[0-9]{2}/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} by [^ ]+#\1$updated by $author#" "$file"
            else
              longest() {
                printf "%s\n" "$@" | awk '{ print length, $0 }' | sort -nr | head -1 | cut -d" " -f2-
              }
              max_len=80


              filename_len=${#filename}
              author_email="${author} <${email}>"
              author_email_len=${#author_email}
              created_len=${#created}
              updated_len=${#updated}
              author_len=${#author}

              pad() {
                local base="$1"
                local target_len=$2
                local base_len=${#base}
                local diff=$((target_len - base_len))
                if [ $diff -lt 0 ]; then diff=0; fi
                printf "%s%*s" "$base" $diff ""
              }

              line1="/* ************************************************************************** */"
              line2="/*                                                                            */"
              line3="/*                                                        :::      ::::::::   */"
              line4_prefix="/*   "
              line4_suffix=":+:      :+:    :+:   */"
              line4_middle=$(pad "$filename" $((47)))  # 47 chars for filename with padding
              line4="${line4_prefix}${line4_middle}${line4_suffix}"

              line5="/*                                                    +:+ +:+         +:+     */"

              line6_prefix="/*   By: "
              line6_suffix="+#+  +:+       +#+        */"
              line6_middle=$(pad "$author_email" 37)
              line6="${line6_prefix}${line6_middle}${line6_suffix}"

              line7="/*                                                +#+#+#+#+#+   +#+           */"

              line8_prefix="/*   Created: "
              line8_suffix=" #+#    #+#             */"
              created_line_content="${created} by ${author}"
              created_line_padded=$(pad "$created_line_content" $((52)))
              line8="${line8_prefix}${created_line_padded}${line8_suffix}"

              line9_prefix="/*   Updated: "
              line9_suffix=" ###   ########.fr       */"
              updated_line_content="${updated} by ${author}"
              updated_line_padded=$(pad "$updated_line_content" $((52)))
              line9="${line9_prefix}${updated_line_padded}${line9_suffix}"

              line10="/*                                                                            */"
              line11="/* ************************************************************************** */"

              {
                echo "$line1"
                echo "$line2"
                echo "$line3"
                echo "$line4"
                echo "$line5"
                echo "$line6"
                echo "$line7"
                echo "$line8"
                echo "$line9"
                echo "$line10"
                echo "$line11"
                echo ""
                cat "$file"
              } > "$file.tmp" && mv "$file.tmp" "$file"
            fi
          done

      - name: Format Code
        run: |
          for file in $(find . -type f \( -name "*.c" -o -name "*.h" \)); do
            sed -i 's/[ \t]*$//' "$file"
            expand -t 4 "$file" > tmp && mv tmp "$file"
          done

      - uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "ci: apply norminette format and add 42 headers"
          commit_user_name: "${{ github.actor }}"
          commit_user_email: "contact.devsoufiano@gmail.com"
