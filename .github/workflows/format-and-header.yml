name: Format and Add 42 Header

on:
  push:
    branches:
      - main

jobs:
  format-and-header:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "contact.devsoufiano@gmail.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Norminette
        run: |
          python3 -m pip install --upgrade pip
          pip install norminette

      - name: Add 42 Header
        run: |
          author="${{ github.actor }}"
          email="contact.devsoufiano@gmail.com"
          for file in $(find . -type f \( -name "*.c" -o -name "*.h" \)); do
            filename=$(basename "$file")
            created=$(git log --diff-filter=A --format="%ad" --date=format:"%Y/%m/%d %H:%M:%S" -- "$file" | head -n 1)
            [ -z "$created" ] && created=$(date +"%Y/%m/%d %H:%M:%S")
            updated=$(date +"%Y/%m/%d %H:%M:%S")
            
            if ! head -n 1 "$file" | grep -q "/\* \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*"; then
              temp_file=$(mktemp)
              {
                echo "/* ************************************************************************** */"
                echo "/*                                                                            */"
                echo "/*                                                        :::      ::::::::   */"
                printf "/*   %-47s:+:      :+:    :+:   */\n" "$filename"
                echo "/*                                                    +:+ +:+         +:+     */"
                printf "/*   By: %-42s+#+  +:+       +#+        */\n" "SoufianoDev <$email>"
                echo "/*                                                +#+#+#+#+#+   +#+           */"
                printf "/*   Created: %s by %-10s#+#    #+#             */\n" "$created" "SoufianoDev"
                printf "/*   Updated: %s by %-10s###   ########.fr       */\n" "$updated" "SoufianoDev"
                echo "/*                                                                            */"
                echo "/* ************************************************************************** */"
                echo ""
                cat "$file"
              } > "$temp_file"
              mv "$temp_file" "$file"
            fi
          done

      - name: Format Code
        run: |
          for file in $(find . -type f \( -name "*.c" -o -name "*.h" \)); do
            sed -i 's/[ \t]*$//' "$file"
            expand -t 4 "$file" > tmp && mv tmp "$file"
          done

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: apply norminette format and add 42 headers"
          commit_user_name: "SoufianoDev"
          commit_user_email: "contact.devsoufiano@gmail.com"