name: Update 42 Headers

on:
  push:
    branches: [main]

jobs:
  update-headers:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Process Headers
        run: |
          set -eo pipefail
          author="SoufianoDev"
          header_email="contact.devsoufiano@gmail.com"
          updated=$(date +"%Y/%m/%d %H:%M:%S")
          target_length=84
          ref_filename="ft_putchar.c"
          ruler="/*   $ref_filename"
          template_line="$ruler                                       :+:      :+:    :+:   */"
          spaces_str=${template_line#"$ruler"}
          spaces_str=${spaces_str%%:+:*}
          reserved_space=${#spaces_str}
          suffix=":+:      :+:    :+:   */"

          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            filename_len=${#filename}
            diff_len=$(( filename_len - ${#ref_filename} ))
            spaces_after=$(( reserved_space - diff_len ))
            (( spaces_after < 0 )) && spaces_after=0
            new_ruler="/*   $filename"
            new_line=$(printf "%s%*s%s" "$new_ruler" "$spaces_after" "" "$suffix")

            if head -n 1 "$file" | grep -q "/\* \*\*\*"; then
              current_line=$(grep -m1 -E "/\*   .*:\+:" "$file")
              current_filename=$(echo "$current_line" | sed -E 's/\/\*   ([^ ]+).*/\1/')
              sed -i -E \
                -e "s|/\*   ${current_filename}.*\*/|${new_line}|" \
                -e "s|(Updated: )[0-9]{4}/[0-9]{2}/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} by [^ ]+|\1$updated by $author|" \
                "$file"
            else
              created=$(git log --diff-filter=A --format="%ad" --date=format:"%Y/%m/%d %H:%M:%S" -- "$file" | head -n1 || date +"%Y/%m/%d %H:%M:%S")
              
              # Create the reference header using printf to avoid YAML parsing issues
              reference_header=$(printf "%s\n" \
                "/* ************************************************************************** */" \
                "/*                                                                            */" \
                "/*                                                        :::      ::::::::   */" \
                "/*   ft_putchar.c                                       :+:      :+:    :+:   */" \
                "/*                                                    +:+ +:+         +:+     */" \
                "/*   By: SoufianoDev <contact.devsoufiano@gmail.com> +#+  +:+       +#+        */" \
                "/*                                                +#+#+#+#+#+   +#+           */" \
                "/*   Created: 2025/06/16 19:52:01 by SoufianoDev       #+#    #+#             */" \
                "/*   Updated: 2025/06/16 18:52:18 by SoufianoDev       ###   ########.fr       */" \
                "/*                                                                            */" \
                "/* ************************************************************************** */")
              
              new_header=$(echo "$reference_header" | \
                sed -e "s|ft_putchar.c|${filename}|" \
                    -e "s|2025/06/16 19:52:01|${created}|" \
                    -e "s|2025/06/16 18:52:18|${updated}|")
              new_header=$(echo "$new_header" | awk -v line="$new_line" '
                /\/\*   .*:\+:/ {
                  print line
                  next
                }
                { print }
              ')
              temp_file=$(mktemp)
              echo "$new_header" > "$temp_file"
              printf "\n" >> "$temp_file"
              cat "$file" >> "$temp_file"
              mv "$temp_file" "$file"
            fi
          done < <(find . -type f \( -name "*.c" -o -name "*.h" \) -print0)

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "ci: update headers using reference template"
          commit_user_name: "${{ github.actor }}"
          commit_user_email: "${{ github.actor }}@users.noreply.github.com"